#!/bin/bash

# IllY Configuration Launcher

ILLY_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$ILLY_DIR/.IllY"
VENV_ACTIVATED=false

echo "ğŸ”§ Launching IllY Configuration..."

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo "âŒ Error: Python 3 is required for IllY"
    exit 1
fi

# Create or activate virtual environment
if [ ! -d "$VENV_DIR" ]; then
    echo "ğŸ“¦ Creating virtual environment (.IllY)..."
    python3 -m venv "$VENV_DIR"
    
    if [ $? -ne 0 ]; then
        echo "âŒ Error: Failed to create virtual environment"
        exit 1
    fi
    
    echo "âœ… Virtual environment created"
fi

# Activate virtual environment
if [ -f "$VENV_DIR/bin/activate" ]; then
    source "$VENV_DIR/bin/activate"
    VENV_ACTIVATED=true
    echo "ğŸ”Œ Virtual environment activated"
elif [ -f "$VENV_DIR/Scripts/activate" ]; then
    source "$VENV_DIR/Scripts/activate"
    VENV_ACTIVATED=true
    echo "ğŸ”Œ Virtual environment activated (Windows)"
else
    echo "âš ï¸  Warning: Could not activate virtual environment"
fi

# Install system dependencies if needed
if command -v apt-get &> /dev/null; then
    PORTAUDIO_PKGS="portaudio19-dev portaudio-dev"
    INSTALLED=false
    
    for pkg in $PORTAUDIO_PKGS; do
        if dpkg -s "$pkg" &> /dev/null 2>&1; then
            INSTALLED=true
            break
        fi
    done
    
    if [ "$INSTALLED" = false ]; then
        echo "ğŸ“¦ Installing system dependencies (portaudio)..."
        sudo apt-get update -qq
        
        for pkg in $PORTAUDIO_PKGS; do
            if apt-cache show "$pkg" &> /dev/null 2>&1; then
                sudo apt-get install -y -qq "$pkg"
                if [ $? -eq 0 ]; then
                    echo "âœ… Installed $pkg"
                    break
                fi
            fi
        done
        
        if [ "$INSTALLED" = false ]; then
            if ! dpkg -s portaudio19-dev portaudio-dev &> /dev/null 2>&1; then
                echo "âš ï¸  Warning: Failed to install portaudio dev packages, pyaudio may fail to build"
            fi
        fi
    fi
fi

# Install dependencies if needed
if [ "$VENV_ACTIVATED" = true ]; then
    if [ -f "$ILLY_DIR/requirements.txt" ]; then
        echo "ğŸ“¥ Installing dependencies..."
        python -m pip install -q --upgrade pip
        python -m pip install -q -r "$ILLY_DIR/requirements.txt"
        
        if [ $? -eq 0 ]; then
            echo "âœ… Dependencies installed successfully"
        else
            echo "âŒ Error: Failed to install dependencies"
            exit 1
        fi
    fi
fi

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "âŒ Error: Node.js is required for configuration GUI"
    exit 1
fi

# Launch config server
cd "$ILLY_DIR"
node config-server.js &

CONFIG_PID=$!
echo "âœ… Configuration GUI launched (PID: $CONFIG_PID)"
echo "Opening http://localhost:5050 in your browser..."
echo ""
echo "ğŸ’¡ Tip: Set your PicoVoice API key in the configuration to enable wake word detection"
echo "ğŸ›‘ Press Ctrl+C to stop the configuration server"
